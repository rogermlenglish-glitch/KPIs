<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>KPIs Serenazgo - Gasolina (GL) con Validaci√≥n ‚â§100 por d√≠a</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tipograf√≠as -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Poppins:wght@500;700&display=swap" rel="stylesheet">
  <!-- Chart.js v4 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    :root{
      --bg: #f5f7fb; --bg-soft: #eef2f8; --card: #ffffff; --text: #0f172a;
      --muted: #64748b; --border: #e5e9f0; --shadow: 0 6px 24px rgba(15, 23, 42, 0.08);
      --radius: 16px; --primary: #2563eb; --primary-600:#1d4ed8; --primary-50:#eff6ff;
      --grid: #e6eaf2; --gap: 18px; --canvas-h: 540px;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b1220; --bg-soft:#0e1627; --card:#0f182a; --text:#e6edf6;
        --muted:#98a2b3; --border:#1f2a3c; --shadow:0 10px 30px rgba(0,0,0,.5);
        --primary:#5aa6ff; --primary-600:#4794ef; --primary-50:#0e274f; --grid:#263349;
      }
    }
    @media (max-width:1024px){ :root{ --canvas-h:420px; } }
    @media (max-width:640px){ :root{ --canvas-h:320px; } }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{ margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif; background:var(--bg); color:var(--text); line-height:1.45; }

    .hero{
      padding: 34px 16px 28px;
      background: radial-gradient(1200px 400px at 10% 0%, var(--primary-50), transparent 60%),
                  linear-gradient(180deg, rgba(37,99,235,0.06), transparent 40%);
      border-bottom: 1px solid var(--border);
    }
    .container{ width:100%; max-width:1200px; margin:0 auto; padding:0 16px; }
    .title{ font-family:Poppins,Inter,sans-serif; font-weight:700; letter-spacing:-0.3px; font-size:clamp(22px,2.6vw,32px); margin:0 0 6px; }
    .subtitle{ margin:0; color:var(--muted); font-size:clamp(12px,1.6vw,14px); }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); }

    .filters{ display:grid; grid-template-columns:1fr 1fr; gap:var(--gap); margin-top:-24px; }
    @media (min-width:900px){ .filters{ grid-template-columns:repeat(6, minmax(140px,1fr)); } }
    .field{ display:flex; flex-direction:column; }
    .label{ font-size:12px; color:var(--muted); margin:10px 0 6px 2px; font-weight:600; }
    .input, .search{
      width:100%; padding:12px; background:#fff0; border:1px solid var(--border); border-radius:12px; color:var(--text); outline:none;
    }
    .input:focus, .search:focus{ border-color:var(--primary); box-shadow:0 0 0 3px color-mix(in oklab, var(--primary) 20%, transparent); }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:12px 14px;
      border:none; border-radius:12px; background:var(--primary); color:#fff; font-weight:700; cursor:pointer;
      transition: transform .05s ease, box-shadow .2s ease, background .2s ease;
      box-shadow: 0 8px 18px color-mix(in oklab, var(--primary) 20%, transparent);
    }
    .btn:hover{ background:var(--primary-600); }
    .btn:active{ transform: translateY(1px); }

    .box{ grid-column:1 / -1; padding:14px; }
    .box-header{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:10px; }
    .soft{ color:var(--muted); font-size:12px; }

    .checks{ display:grid; gap:10px; grid-template-columns:repeat(auto-fill, minmax(220px,1fr)); }
    .check{ display:inline-flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid var(--border); border-radius:12px;
            background: color-mix(in oklab, var(--bg-soft) 70%, transparent); transition: border-color .2s ease, background .2s ease; }
    .check:hover{ border-color:var(--primary); background: color-mix(in oklab, var(--primary-50) 25%, transparent); }
    .check input[type="checkbox"]{
      appearance:none; width:18px; height:18px; border:2px solid var(--border); border-radius:6px; display:grid; place-content:center; background:#fff0; cursor:pointer; transition:border-color .2s, background .2s;
    }
    .check input[type="checkbox"]::before{ content:""; width:10px; height:10px; transform:scale(0); transition:transform .12s ease-in-out; background:var(--primary); border-radius:2px; }
    .check input[type="checkbox"]:checked{ border-color:var(--primary); background: color-mix(in oklab, var(--primary) 20%, transparent); }
    .check input[type="checkbox"]:checked::before{ transform: scale(1); }

    .kpis{ display:grid; gap:var(--gap); margin:18px 0 16px; grid-template-columns:1fr; }
    @media (min-width:850px){ .kpis{ grid-template-columns:repeat(3, minmax(220px,1fr)); } }
    .kpi{ padding: clamp(14px,2vw,18px); }
    .kpi h3{ margin:0 0 8px; font-weight:600; color:var(--muted); font-size:clamp(12px,1.7vw,14px); }
    .kpi .value{ font-weight:800; letter-spacing:-0.3px; font-size:clamp(20px,3.2vw,28px); }

    .charts{ display:grid; gap:var(--gap); grid-template-columns:1fr; margin-bottom:8px; }
    @media (min-width:1100px){ .charts{ grid-template-columns:1fr 1fr; } .full{ grid-column:1 / -1; } }
    .chart{ height:var(--canvas-h); padding:12px; }
    .chart canvas{ width:100% !important; height:100% !important; display:block; }

    .section-title{ margin:18px 4px 10px; font-family:Poppins,Inter,sans-serif; font-weight:700; font-size:clamp(16px,2vw,20px); }
    .table-wrap{ overflow:auto; }
    table{ width:100%; border-collapse:collapse; }
    thead th{
      position:sticky; top:0; background: color-mix(in oklab, var(--bg-soft) 80%, var(--card) 20%);
      border-bottom:1px solid var(--border); color:var(--muted); font-weight:700; text-transform:uppercase; letter-spacing:.02em; font-size:12px;
    }
    th,td{ padding:12px 14px; white-space:nowrap; border-bottom:1px solid var(--border); }
    tbody tr:nth-child(odd){ background: color-mix(in oklab, var(--card) 90%, var(--bg-soft) 10%); }
    tfoot td{ font-weight:700; background: color-mix(in oklab, var(--bg-soft) 70%, var(--card) 30%); }

    .muted{ color:var(--muted); font-size:12px; margin-top:8px; }
    .error{ display:none; margin:14px 0; padding:12px; border-radius:12px; background:#fee2e2; border:1px solid #fecaca; color:#991b1b; }
    .badge{ display:inline-block; padding:2px 8px; border-radius:999px; background:var(--primary-50); color:var(--primary-600); font-size:11px; font-weight:700; margin-left:6px; }
  </style>
</head>
<body>
  <header class="hero">
    <div class="container">
      <h1 class="title">KPIs Movilidad Serenazgo ‚Äî Julio 2025 <span class="badge">Gasolina (GL)</span></h1>
      <p class="subtitle">Filtra por fecha, conductores y veh√≠culos. Validaci√≥n autom√°tica: ning√∫n d√≠a supera 100 GL.</p>
    </div>
  </header>

  <main class="container" style="margin-top:20px;">
    <div id="errorBox" class="error"></div>

    <!-- FILTROS -->
    <section class="filters">
      <div class="field">
        <label class="label" for="startDate">Desde</label>
        <input class="input" type="date" id="startDate" />
      </div>
      <div class="field">
        <label class="label" for="endDate">Hasta</label>
        <input class="input" type="date" id="endDate" />
      </div>
      <div class="field" style="grid-column:span 2;">
        <label class="label" for="buscarConductor">Buscar conductor (opcional)</label>
        <input class="search" type="text" id="buscarConductor" placeholder="Ej.: FREBER, RULY, DAVID..." />
      </div>
      <div class="field">
        <label class="label">&nbsp;</label>
        <button id="btnFiltrar" class="btn" type="button" title="Aplicar filtros">Aplicar filtros</button>
      </div>

      <!-- Conductores -->
      <div class="box card">
        <div class="box-header">
          <label class="check">
            <input type="checkbox" id="chkTodosConductores" checked />
            <span><strong>Seleccionar todos</strong> ‚Äî Conductores</span>
          </label>
          <span id="infoConductores" class="soft"></span>
        </div>
        <div id="conductoresList" class="checks"></div>
      </div>

      <!-- Veh√≠culos: 4 casillas fijas -->
      <div class="box card">
        <div class="box-header">
          <label class="check">
            <input type="checkbox" id="chkTodosVehiculos" checked />
            <span><strong>Seleccionar todos</strong> ‚Äî Veh√≠culos (4)</span>
          </label>
          <span id="infoVehiculos" class="soft"></span>
        </div>
        <div id="vehiculosList" class="checks"></div>
      </div>
    </section>

    <!-- KPIs -->
    <section class="kpis">
      <article class="kpi card"><h3>Gasolina total (GL)</h3><div id="kpiCombustibleTotal" class="value">0</div></article>
      <article class="kpi card"><h3>Gasolina total (‚âà Litros)</h3><div id="kpiCombustibleLitros" class="value">0</div></article>
      <article class="kpi card"><h3>Registros filtrados</h3><div id="kpiRegistros" class="value">0</div></article>
    </section>

    <!-- GR√ÅFICOS -->
    <section class="charts">
      <div class="chart card full"><canvas id="combustibleChart"></canvas></div>
      <div class="chart card"><canvas id="kmPromedioChart"></canvas></div>
      <div class="chart card"><canvas id="recorridoTotalChart"></canvas></div>
    </section>

    <!-- TABLAS -->
    <h2 class="section-title">Tabla de KPIs (por turno)</h2>
    <div id="kpiTableWrap" class="table-wrap card"></div>

    <h2 class="section-title">Tabla completa (como en el Excel)</h2>
    <div id="rawTableWrap" class="table-wrap card"></div>

    <p class="muted" id="resume"></p>
  </main>

  <script>
    /* ====== DATA EMBEBIDA ======
       üëâ PEGA AQU√ç la data real del Excel ‚ÄúAC KM DE LAS MOVILES DE SERENAZGO JULIO 2025.xlsx‚Äù
       Formato por registro:
       {
         "Fecha":"YYYY-MM-DD","Turno":"DIA|TARDE|NOCHE","Conductor":"...","Unidad_Movil":"EUG-707|EUG-717|EX-7680|EX-7664|...",
         "KM_Inicial":151795,"KM_Final":151837,"Recorrido":42,
         "Combustible": 0..100, "Cambio_Aceite":null, "Mantenimiento":null, "Ocurrencias":null
       }
       Regla validada: Combustible (GL) <= 100 por registro y suma diaria <= 100.
    */
    const DATA = [
      /* ===== EJEMPLOS (BORRA Y PEGA TU DATA REAL) ===== */
      {"Fecha":"2025-07-25","Turno":"TARDE","Conductor":"WILSON LUDE√ëA","Unidad_Movil":"EUG-717","KM_Inicial":153606,"KM_Final":153666,"Recorrido":60,"Combustible":60,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},
      {"Fecha":"2025-07-27","Turno":"TARDE","Conductor":"WILSON LUDE√ëA","Unidad_Movil":"EUG-717","KM_Inicial":154040,"KM_Final":154114,"Recorrido":74,"Combustible":55,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},
      {"Fecha":"2025-07-29","Turno":"DIA","Conductor":"RULY PAREDES","Unidad_Movil":"EUG-717","KM_Inicial":154380,"KM_Final":154452,"Recorrido":72,"Combustible":80,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},
      /* M√°s filas‚Ä¶ */
    ];

    /* ====== Veh√≠culos fijos (4 casillas) ====== */
    const VEHICULOS = [
      { id: 'EUG-707', tipo: 'Camioneta' },
      { id: 'EUG-717', tipo: 'Camioneta' },
      { id: 'EX-7680', tipo: 'Motocicleta' },
      { id: 'EX-7664', tipo: 'Motocicleta' },
    ];

    /* ===== Overlay errores ===== */
    (function () {
      const box = document.getElementById('errorBox');
      window.addEventListener('error', ev => { box.style.display='block'; box.textContent = 'Error JS: '+(ev.message||ev.error||''); });
      window.addEventListener('unhandledrejection', ev => { box.style.display='block'; box.textContent = 'Error Promesa: '+(ev.reason?.message || ev.reason || ''); });
    })();

    /* ===== Helpers & Validaci√≥n ===== */
    const TURNOS = ["DIA","TARDE","NOCHE"];
    const toNumber = v => Number.isFinite(+v) ? +v : 0;
    const parseDateISO = s => { const d = new Date(s); return isNaN(d.getTime()) ? null : d; };
    const formatISO = d => d.toISOString().slice(0,10);
    const GL_TO_L = 3.785; // 1 gal√≥n ‚âà 3.785 litros

    function canonicalUnidad(u){
      if(!u) return '';
      return String(u).toUpperCase().replace(/\s+/g,'');
    }
    function getVehicleType(unidad){
      const cu = canonicalUnidad(unidad);
      if (cu.includes('EUG-707') || cu.includes('EUG707')) return 'Camioneta';
      if (cu.includes('EUG-717') || cu.includes('EUG717')) return 'Camioneta';
      if (cu.includes('EX-7680') || cu.includes('EX7680')) return 'Motocicleta';
      if (cu.includes('EX-7664') || cu.includes('EX7664')) return 'Motocicleta';
      return 'Otro';
    }

    function getMinMaxDate(rows){
      const dates = rows.map(r => parseDateISO(r.Fecha)).filter(Boolean);
      if(!dates.length) return {min:null, max:null};
      return { min:new Date(Math.min(...dates)), max:new Date(Math.max(...dates)) };
    }

    // Validaci√≥n: cada registro <=100 GL, suma por fecha <=100 GL
    function validateFuel(rows){
      const errors = [];
      const perDate = {};
      rows.forEach(r=>{
        const d = r.Fecha || '(sin fecha)';
        const gl = toNumber(r.Combustible);
        if (gl > 100){
          errors.push(`Registro: ${d} ‚Äî ${r.Unidad_Movil||''} ‚Äî ${r.Conductor||''}: ${gl} GL > 100`);
        }
        if (!perDate[d]) perDate[d] = 0;
        perDate[d] += gl;
      });
      Object.entries(perDate).forEach(([d,sum])=>{
        if (sum > 100){
          errors.push(`Suma diaria: ${d} = ${sum.toFixed(2)} GL (supera 100 GL)`);
        }
      });
      return errors;
    }

    function calcularKPIs(rows){
      const combustiblePorTurno = TURNOS.map(t => rows.filter(r=>r.Turno===t).reduce((a,r)=>a+toNumber(r.Combustible),0));
      const kmPromedioPorTurno = TURNOS.map(t => {
        const recs = rows.filter(r=>r.Turno===t).map(r=>toNumber(r.Recorrido));
        const sum = recs.reduce((a,b)=>a+b,0);
        return Number((recs.length ? sum/recs.length : 0).toFixed(2));
      });
      const recorridoTotalPorTurno = TURNOS.map(t => rows.filter(r=>r.Turno===t).reduce((a,r)=>a+toNumber(r.Recorrido),0));
      const totalCombGL = combustiblePorTurno.reduce((a,b)=>a+b,0);
      const totalCombL  = totalCombGL * GL_TO_L;
      return { combustiblePorTurno, kmPromedioPorTurno, recorridoTotalPorTurno, totalCombGL, totalCombL };
    }

    function filtrarDatos(rows, startDate, endDate, conductoresSeleccionados, vehiculosSeleccionados){
      const sd = startDate ? parseDateISO(startDate) : null;
      const ed = endDate   ? parseDateISO(endDate)   : null;
      const setCond = new Set(conductoresSeleccionados);
      const setVeh  = new Set(vehiculosSeleccionados); // 'EUG-707', etc.
      return rows.filter(item => {
        const f = parseDateISO(item.Fecha);
        const byDate = (!sd || (f && f >= sd)) && (!ed || (f && f <= ed));
        const byCond = !setCond.size || setCond.has(String(item.Conductor||""));
        const cu = canonicalUnidad(item.Unidad_Movil);
        const byVeh  = !setVeh.size || Array.from(setVeh).some(id => cu.includes(id));
        return byDate && byCond && byVeh;
      });
    }

    /* ===== Charts ===== */
    let combustibleChart, kmPromedioChart, recorridoTotalChart;

    const baseScales = (yLabel) => ({
      x:{ grid:{ color:getComputedStyle(document.documentElement).getPropertyValue('--grid') },
          ticks:{ color:getComputedStyle(document.documentElement).getPropertyValue('--muted') } },
      y:{ beginAtZero:true, grid:{ color:getComputedStyle(document.documentElement).getPropertyValue('--grid') },
          ticks:{ color:getComputedStyle(document.documentElement).getPropertyValue('--muted') },
          title:{ display:true, text:yLabel } }
    });

    function initCharts(kpis){
      const c1 = document.getElementById('combustibleChart').getContext('2d');
      const c2 = document.getElementById('kmPromedioChart').getContext('2d');
      const c3 = document.getElementById('recorridoTotalChart').getContext('2d');

      combustibleChart = new Chart(c1, {
        type:'bar',
        data:{
          labels:["D√çA","TARDE","NOCHE"],
          datasets:[{ label:'Gasolina por Turno (GL, suma)', data:kpis.combustiblePorTurno, borderWidth:1 }]
        },
        options:{
          responsive:true, maintainAspectRatio:false, resizeDelay:150, interaction:{mode:'index', intersect:false},
          plugins:{
            legend:{ position:'top', labels:{ boxWidth:12, usePointStyle:true,
              color:getComputedStyle(document.documentElement).getPropertyValue('--muted') } },
            tooltip:{ callbacks:{
              label: ctx=>{
                const v = ctx.parsed.y||0;
                return `${ctx.dataset.label}: ${v.toFixed(2)} GL (‚âà ${(v*3.785).toFixed(0)} L)`;
              }
            }}
          },
          scales: baseScales('GL')
        }
      });

      kmPromedioChart = new Chart(c2, {
        type:'bar',
        data:{
          labels:["D√çA","TARDE","NOCHE"],
          datasets:[{ label:'Kilometraje Promedio por Turno', data:kpis.kmPromedioPorTurno, borderWidth:1 }]
        },
        options:{
          responsive:true, maintainAspectRatio:false, resizeDelay:150, interaction:{mode:'index', intersect:false},
          plugins:{ legend:{ position:'top', labels:{ boxWidth:12, usePointStyle:true,
            color:getComputedStyle(document.documentElement).getPropertyValue('--muted') } } },
          scales: baseScales('Km')
        }
      });

      recorridoTotalChart = new Chart(c3, {
        type:'bar',
        data:{
          labels:["D√çA","TARDE","NOCHE"],
          datasets:[{ label:'Recorrido Total por Turno', data:kpis.recorridoTotalPorTurno, borderWidth:1 }]
        },
        options:{
          responsive:true, maintainAspectRatio:false, resizeDelay:150, interaction:{mode:'index', intersect:false},
          plugins:{ legend:{ position:'top', labels:{ boxWidth:12, usePointStyle:true,
            color:getComputedStyle(document.documentElement).getPropertyValue('--muted') } } },
          scales: baseScales('Km')
        }
      });
    }

    function updateCharts(kpis){
      if(!(combustibleChart && kmPromedioChart && recorridoTotalChart)) return;
      combustibleChart.data.datasets[0].data = kpis.combustiblePorTurno;
      kmPromedioChart.data.datasets[0].data  = kpis.kmPromedioPorTurno;
      recorridoTotalChart.data.datasets[0].data = kpis.recorridoTotalPorTurno;
      combustibleChart.update(); kmPromedioChart.update(); recorridoTotalChart.update();
    }

    /* ===== Render UI ===== */
    function renderKpiCards(kpis, registros, totalRegistros){
      document.getElementById('kpiCombustibleTotal').textContent = `${kpis.totalCombGL.toFixed(2)} GL`;
      document.getElementById('kpiCombustibleLitros').textContent = `‚âà ${kpis.totalCombL.toFixed(0)} L`;
      document.getElementById('kpiRegistros').textContent        = registros;
      document.getElementById('resume').textContent              = `Mostrando ${registros} de ${totalRegistros} registros.`;
    }
    function renderKpiTable(kpis){
      const wrap=document.getElementById('kpiTableWrap');
      wrap.innerHTML=`<table><thead><tr><th>Turno</th><th>Gasolina (GL, suma)</th><th>Kilometraje Promedio</th><th>Recorrido Total</th></tr></thead><tbody>${
        ["D√çA","TARDE","NOCHE"].map((t,i)=>`<tr><td>${t}</td><td>${kpis.combustiblePorTurno[i].toFixed(2)}</td><td>${kpis.kmPromedioPorTurno[i].toFixed(2)}</td><td>${kpis.recorridoTotalPorTurno[i].toFixed(2)}</td></tr>`).join('')
      }</tbody><tfoot><tr><td>TOTALES</td><td>${kpis.totalCombGL.toFixed(2)}</td><td>‚Äî</td><td>${kpis.recorridoTotalPorTurno.reduce((a,b)=>a+b,0).toFixed(2)}</td></tr></tfoot></table>`;
    }
    function renderRawTable(rows){
      const wrap=document.getElementById('rawTableWrap');
      const safe = v => (v===null||v===undefined)?'':v;
      wrap.innerHTML = `<table><thead><tr>
        <th>Fecha</th><th>Turno</th><th>Conductor</th><th>Unidad_Movil</th><th>Tipo_Veh√≠culo</th>
        <th>KM_Inicial</th><th>KM_Final</th><th>Recorrido</th><th>Gasolina (GL)</th><th>Cambio_Aceite</th><th>Mantenimiento</th><th>Ocurrencias</th>
      </tr></thead><tbody>${
        rows.map(r=>`<tr>
          <td>${safe(r.Fecha)}</td><td>${safe(r.Turno)}</td><td>${safe(r.Conductor)}</td>
          <td>${safe(r.Unidad_Movil)}</td><td>${getVehicleType(r.Unidad_Movil)}</td>
          <td>${safe(r.KM_Inicial)}</td><td>${safe(r.KM_Final)}</td><td>${safe(r.Recorrido)}</td>
          <td>${safe(r.Combustible)}</td><td>${safe(r.Cambio_Aceite)}</td><td>${safe(r.Mantenimiento)}</td><td>${safe(r.Ocurrencias)}</td>
        </tr>`).join('')
      }</tbody></table>`;
    }

    /* UI: conductores y veh√≠culos */
    function buildConductores(){
      const listEl=document.getElementById('conductoresList');
      const chkAll=document.getElementById('chkTodosConductores');
      const infoEl=document.getElementById('infoConductores');
      const buscarEl=document.getElementById('buscarConductor');

      function conductoresValues(){
        const txt=(buscarEl.value||'').toLowerCase();
        const set=new Set(DATA.map(r=>(r.Conductor||'').trim()).filter(Boolean));
        return Array.from(set).filter(n=>n.toLowerCase().includes(txt)).sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}));
      }
      function render(){
        const arr=conductoresValues();
        listEl.innerHTML = arr.map(v=>`<label class="check"><input type="checkbox" class="chk-cond" data-value="${v}" checked/> <span>${v}</span></label>`).join('');
        updateInfo();
      }
      function getSeleccionados(){
        const sel=[]; listEl.querySelectorAll('.chk-cond').forEach(chk=>{ if(chk.checked) sel.push(chk.getAttribute('data-value')); });
        return sel;
      }
      function setAll(checked){ listEl.querySelectorAll('.chk-cond').forEach(chk=> chk.checked=checked); updateInfo(); }
      function updateInfo(){ const total=listEl.querySelectorAll('.chk-cond').length; const sel=getSeleccionados().length; infoEl.textContent=`Seleccionados: ${sel} / ${total}`; chkAll.checked=(sel===total && total>0); chkAll.indeterminate= sel>0 && sel<total; }

      listEl.addEventListener('change', e=>{ if(e.target.classList.contains('chk-cond')) updateInfo(); });
      chkAll.addEventListener('change', ()=> setAll(chkAll.checked));
      buscarEl.addEventListener('input', render);

      render();
      return { getSeleccionados, render };
    }

    function buildVehiculos(){
      const listEl=document.getElementById('vehiculosList');
      const chkAll=document.getElementById('chkTodosVehiculos');
      const infoEl=document.getElementById('infoVehiculos');

      function render(){
        listEl.innerHTML = [
          { id:'EUG-707', label:'EUG-707 ‚Äî Camioneta' },
          { id:'EUG-717', label:'EUG-717 ‚Äî Camioneta' },
          { id:'EX-7680', label:'EX-7680 ‚Äî Motocicleta' },
          { id:'EX-7664', label:'EX-7664 ‚Äî Motocicleta' },
        ].map(v=>`<label class="check"><input type="checkbox" class="chk-veh" data-id="${v.id}" checked/> <span>${v.label}</span></label>`).join('');
        updateInfo();
      }
      function getSeleccionados(){
        const sel=[]; listEl.querySelectorAll('.chk-veh').forEach(chk=>{ if(chk.checked) sel.push(chk.getAttribute('data-id')); });
        return sel;
      }
      function setAll(checked){ listEl.querySelectorAll('.chk-veh').forEach(chk=> chk.checked=checked); updateInfo(); }
      function updateInfo(){ const total=listEl.querySelectorAll('.chk-veh').length; const sel=getSeleccionados().length; infoEl.textContent=`Seleccionados: ${sel} / ${total}`; chkAll.checked=(sel===total && total>0); chkAll.indeterminate= sel>0 && sel<total; }

      listEl.addEventListener('change', e=>{ if(e.target.classList.contains('chk-veh')) updateInfo(); });
      chkAll.addEventListener('change', ()=> setAll(chkAll.checked));

      render();
      return { getSeleccionados };
    }

    /* Wiring */
    document.addEventListener('DOMContentLoaded', ()=>{
      const startEl=document.getElementById('startDate');
      const endEl=document.getElementById('endDate');
      const btn=document.getElementById('btnFiltrar');

      const {min,max} = getMinMaxDate(DATA);
      if(min) startEl.value=formatISO(min);
      if(max) endEl.value=formatISO(max);

      const uiConductores = buildConductores();
      const uiVehiculos   = buildVehiculos();

      // Validaci√≥n de datos (sobre toda la data)
      const errorsAll = validateFuel(DATA);
      const errorBox = document.getElementById('errorBox');
      if (errorsAll.length){
        errorBox.style.display='block';
        errorBox.innerHTML = `<strong>‚ö† Validaci√≥n de gasolina (GL ‚â§ 100 / d√≠a):</strong><br>${errorsAll.map(e=>`‚Ä¢ ${e}`).join('<br>')}`;
      }

      const kpisInit=calcularKPIs(DATA);
      initCharts(kpisInit);
      renderKpiCards(kpisInit, DATA.length, DATA.length);
      renderKpiTable(kpisInit);
      renderRawTable(DATA);

      function aplicarFiltros(){
        const conds = uiConductores.getSeleccionados();
        const vehs  = uiVehiculos.getSeleccionados(); // IDs exactos
        const filtered = filtrarDatos(DATA, startEl.value, endEl.value, conds, vehs);

        // Validaci√≥n sobre subset filtrado (por si necesitas revisar una fecha espec√≠fica tras filtrar)
        const errors = validateFuel(filtered);
        if (errors.length){
          errorBox.style.display='block';
          errorBox.innerHTML = `<strong>‚ö† Validaci√≥n de gasolina (GL ‚â§ 100 / d√≠a):</strong><br>${errors.map(e=>`‚Ä¢ ${e}`).join('<br>')}`;
        } else {
          errorBox.style.display='none';
        }

        const kpis = calcularKPIs(filtered);
        updateCharts(kpis);
        renderKpiCards(kpis, filtered.length, DATA.length);
        renderKpiTable(kpis);
      }

      btn.addEventListener('click', aplicarFiltros);
      startEl.addEventListener('change', aplicarFiltros);
      endEl.addEventListener('change', aplicarFiltros);
      document.getElementById('conductoresList').addEventListener('change', aplicarFiltros);
      document.getElementById('vehiculosList').addEventListener('change', aplicarFiltros);
      document.getElementById('chkTodosConductores').addEventListener('change', aplicarFiltros);
      document.getElementById('chkTodosVehiculos').addEventListener('change', aplicarFiltros);
    });
  </script>
</body>
</html>


     
   

