<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>KPIs Serenazgo - Interactivo (Responsive, Fix Canvas)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js v4 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    :root{
      --gap:16px;
      --canvas-h:520px; /* Desktop */
    }
    @media (max-width:1024px){ :root{ --canvas-h:420px; } } /* Tablet */
    @media (max-width:640px){ :root{ --canvas-h:320px; } }  /* Móvil  */

    *{ box-sizing:border-box; }
    body{ font-family:Arial,Helvetica,sans-serif; margin:20px; background:#f6f7f9; color:#222; }
    .container{ width:100%; max-width:1200px; margin:0 auto; }
    h1{ margin:0 0 6px; font-size:clamp(18px,2.4vw,28px); }
    p.hint{ margin:0 0 16px; color:#555; font-size:clamp(12px,1.6vw,14px); }

    /* Filtros */
    .filters{ display:grid; grid-template-columns:1fr 1fr; gap:var(--gap); margin-bottom:16px; }
    @media (min-width:768px){ .filters{ grid-template-columns:repeat(6,minmax(120px,1fr)); } }
    .filters label{ display:block; font-size:12px; color:#444; margin-bottom:6px; }
    .filters input[type="date"], .filters input[type="text"]{
      width:100%; padding:10px; border:1px solid #d7dbe3; border-radius:10px; background:#fff; font-size:14px;
    }
    .filters button{
      padding:12px 14px; border:none; border-radius:12px; cursor:pointer; background:#1f7aec; color:#fff; font-weight:600;
    }

    /* Lista conductores */
    .conductores-box{ grid-column:1 / -1; background:#fff; border-radius:12px; padding:12px; border:1px solid #e5e5e5; max-height:260px; overflow:auto; }
    .conductores-actions{ display:flex; gap:12px; align-items:center; margin-bottom:8px; flex-wrap:wrap; }
    .conductores-grid{ display:grid; gap:8px; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); }
    .conductor-item{ font-size:14px; }

    /* Tarjetas KPI */
    .kpi-cards{ display:grid; grid-template-columns:1fr; gap:12px; margin:12px 0 16px; }
    @media (min-width:768px){ .kpi-cards{ grid-template-columns:repeat(3,minmax(160px,1fr)); } }
    .kpi-card{ background:#fff; border-radius:14px; padding:clamp(10px,2vw,14px); box-shadow:0 2px 8px rgba(0,0,0,.06); }
    .kpi-card h3{ margin:0 0 6px; font-size:clamp(12px,1.8vw,14px); color:#666; }
    .kpi-card .value{ font-size:clamp(18px,3vw,24px); font-weight:700; }

    /* Área de gráficos */
    .grid{ display:grid; grid-template-columns:1fr; gap:16px; }
    @media (min-width:1000px){ .grid{ grid-template-columns:1fr 1fr; } .grid .chart-card.full{ grid-column:1 / -1; } }

    .chart-card{
      position:relative; background:#fff; border-radius:14px; box-shadow:0 2px 8px rgba(0,0,0,.06);
      height:var(--canvas-h); padding:12px;
    }
    .chart-card canvas{
      display:block; width:100% !important; height:100% !important;
    }

    /* Tabla KPIs */
    table{ width:100%; border-collapse:collapse; background:#fff; border-radius:14px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,.06); }
    th,td{ padding:10px 12px; border-bottom:1px solid #eef1f6; text-align:left; font-size:clamp(12px,1.8vw,14px); }
    thead th{ background:#f3f6fb; }
    tfoot td{ background:#fafafa; font-weight:600; }

    .muted{ color:#666; font-size:clamp(11px,1.6vw,13px); margin-top:6px; }
    .error-box{ background:#fff3f3; border:1px solid #ffd9d9; color:#a30000; padding:10px 12px; border-radius:10px; margin:10px 0; display:none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>KPIs Movilidad Serenazgo - Julio 2025</h1>
    <p class="hint">Filtra por fecha y marca los conductores que quieras analizar. Los KPIs se recalculan en tiempo real.</p>

    <div id="errorBox" class="error-box"></div>

    <div class="filters">
      <div>
        <label for="startDate">Desde</label>
        <input type="date" id="startDate" />
      </div>
      <div>
        <label for="endDate">Hasta</label>
        <input type="date" id="endDate" />
      </div>
      <div style="grid-column: span 2;">
        <label for="buscarConductor">Buscar conductor (opcional)</label>
        <input type="text" id="buscarConductor" placeholder="Ej.: FREBER, RULY, DAVID..." />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="btnFiltrar" type="button">Filtrar</button>
      </div>
      <div class="conductores-box">
        <div class="conductores-actions">
          <label><input type="checkbox" id="chkTodos" checked /> Seleccionar todos</label>
          <span id="seleccionadosInfo" class="muted"></span>
        </div>
        <div id="conductoresList" class="conductores-grid"></div>
      </div>
    </div>

    <div class="kpi-cards">
      <div class="kpi-card">
        <h3>Combustible total (todos los turnos)</h3>
        <div id="kpiCombustibleTotal" class="value">0</div>
      </div>
      <div class="kpi-card">
        <h3>Recorrido total (todos los turnos)</h3>
        <div id="kpiRecorridoTotal" class="value">0</div>
      </div>
      <div class="kpi-card">
        <h3>Registros filtrados</h3>
        <div id="kpiRegistros" class="value">0</div>
      </div>
    </div>

    <div class="grid">
      <div class="chart-card full"><canvas id="combustibleChart"></canvas></div>
      <div class="chart-card"><canvas id="kmPromedioChart"></canvas></div>
      <div class="chart-card"><canvas id="recorridoTotalChart"></canvas></div>
    </div>

    <h2>Tabla de KPIs (por turno)</h2>
    <div id="kpiTableWrap"></div>

    <div class="muted" id="resume"></div>
  </div>

  <script>
    // ====== DATA EMBEBIDA ======
    const DATA = [{"Fecha":"2025-07-01","Turno":"DIA","Conductor":"ALVARO SUBILETA","Unidad_Movil":"EUG-707","KM_Inicial":151795.0,"KM_Final":151837.0,"Recorrido":42.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-01","Turno":"DIA","Conductor":"DAVID CACERES","Unidad_Movil":"EX - 7680","KM_Inicial":7576.0,"KM_Final":7897.0,"Recorrido":321.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-01","Turno":"TARDE","Conductor":"FREBER MAMANI","Unidad_Movil":"EUG-707","KM_Inicial":151837.0,"KM_Final":151901.0,"Recorrido":64.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-01","Turno":"NOCHE","Conductor":"RULY PAREDES","Unidad_Movil":"EUG-707","KM_Inicial":151901.0,"KM_Final":151944.0,"Recorrido":43.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-02","Turno":"DIA","Conductor":"GONZALO RAMIREZ","Unidad_Movil":"EUG-707","KM_Inicial":151944.0,"KM_Final":151995.0,"Recorrido":51.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-02","Turno":"DIA","Conductor":"DAVID CACERES","Unidad_Movil":"EX - 7680","KM_Inicial":7897.0,"KM_Final":8213.0,"Recorrido":null,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-02","Turno":"TARDE","Conductor":"GONZALO RAMIREZ","Unidad_Movil":"EUG-707","KM_Inicial":151995.0,"KM_Final":152048.0,"Recorrido":53.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-02","Turno":"NOCHE","Conductor":"RULY PAREDES","Unidad_Movil":"EUG-707","KM_Inicial":152048.0,"KM_Final":152095.0,"Recorrido":47.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-03","Turno":"DIA","Conductor":"ALVARO SUBILETA","Unidad_Movil":"EUG-707","KM_Inicial":152095.0,"KM_Final":152156.0,"Recorrido":61.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-03","Turno":"TARDE","Conductor":"FREBER MAMANI","Unidad_Movil":"EUG-707","KM_Inicial":152156.0,"KM_Final":152219.0,"Recorrido":63.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-03","Turno":"NOCHE","Conductor":"RULY PAREDES","Unidad_Movil":"EUG-707","KM_Inicial":152219.0,"KM_Final":152257.0,"Recorrido":38.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-04","Turno":"DIA","Conductor":"ALVARO SUBILETA","Unidad_Movil":"EUG-707","KM_Inicial":152257.0,"KM_Final":152307.0,"Recorrido":50.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-04","Turno":"TARDE","Conductor":"FREBER MAMANI","Unidad_Movil":"EUG-707","KM_Inicial":152307.0,"KM_Final":152367.0,"Recorrido":60.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-04","Turno":"NOCHE","Conductor":"RULY PAREDES","Unidad_Movil":"EUG-707","KM_Inicial":152367.0,"KM_Final":152412.0,"Recorrido":45.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-05","Turno":"DIA","Conductor":"ALVARO SUBILETA","Unidad_Movil":"EUG-707","KM_Inicial":152412.0,"KM_Final":152481.0,"Recorrido":69.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-05","Turno":"TARDE","Conductor":"FREBER MAMANI","Unidad_Movil":"EUG-707","KM_Inicial":152481.0,"KM_Final":152544.0,"Recorrido":63.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-05","Turno":"NOCHE","Conductor":"RULY PAREDES","Unidad_Movil":"EUG-707","KM_Inicial":152544.0,"KM_Final":152594.0,"Recorrido":50.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-06","Turno":"DIA","Conductor":"ALVARO SUBILETA","Unidad_Movil":"EUG-707","KM_Inicial":152594.0,"KM_Final":152646.0,"Recorrido":52.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-06","Turno":"TARDE","Conductor":"FREBER MAMANI","Unidad_Movil":"EUG-707","KM_Inicial":152646.0,"KM_Final":152698.0,"Recorrido":52.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-06","Turno":"NOCHE","Conductor":"RULY PAREDES","Unidad_Movil":"EUG-707","KM_Inicial":152698.0,"KM_Final":152743.0,"Recorrido":45.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-07","Turno":"DIA","Conductor":"ALVARO SUBILETA","Unidad_Movil":"EUG-707","KM_Inicial":152743.0,"KM_Final":152803.0,"Recorrido":60.0,"Combustible":null,"Cambio_Aceite":"151 765","Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-07","Turno":"TARDE","Conductor":"FREBER MAMANI","Unidad_Movil":"EUG-707","KM_Inicial":152803.0,"KM_Final":152871.0,"Recorrido":68.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-07","Turno":"NOCHE","Conductor":"RULY PAREDES","Unidad_Movil":"EUG-707","KM_Inicial":152871.0,"KM_Final":152918.0,"Recorrido":47.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-08","Turno":"DIA","Conductor":"GONZALO RAMIREZ","Unidad_Movil":"EUG-707","KM_Inicial":152918.0,"KM_Final":152988.0,"Recorrido":70.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-08","Turno":"TARDE","Conductor":"FREBER MAMANI","Unidad_Movil":"EUG-707","KM_Inicial":152988.0,"KM_Final":153068.0,"Recorrido":80.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-08","Turno":"NOCHE","Conductor":"JUNIOR PI\u00d1A","Unidad_Movil":"EUG-707","KM_Inicial":153068.0,"KM_Final":153122.0,"Recorrido":54.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-09","Turno":"DIA","Conductor":"GONZALO RAMIREZ","Unidad_Movil":"EUG-707","KM_Inicial":153122.0,"KM_Final":153192.0,"Recorrido":70.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-09","Turno":"TARDE","Conductor":"GONZALO RAMIREZ","Unidad_Movil":"EUG-707","KM_Inicial":153192.0,"KM_Final":153268.0,"Recorrido":76.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-09","Turno":"NOCHE","Conductor":"RULY PAREDES","Unidad_Movil":"EUG-707","KM_Inicial":153268.0,"KM_Final":153322.0,"Recorrido":54.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-10","Turno":"DIA","Conductor":"GONZALO RAMIREZ","Unidad_Movil":"EUG-707","KM_Inicial":153322.0,"KM_Final":153369.0,"Recorrido":47.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-10","Turno":"TARDE","Conductor":"GONZALO RAMIREZ","Unidad_Movil":"EUG-707","KM_Inicial":153369.0,"KM_Final":153451.0,"Recorrido":82.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-10","Turno":"NOCHE","Conductor":"RULY PAREDES","Unidad_Movil":"EUG-707","KM_Inicial":153451.0,"KM_Final":153502.0,"Recorrido":50.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-11","Turno":"DIA","Conductor":"DAVID CACERES","Unidad_Movil":"EUG-707","KM_Inicial":153502.0,"KM_Final":153585.0,"Recorrido":83.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-11","Turno":"TARDE","Conductor":"FREBER MAMANI","Unidad_Movil":"EUG-707","KM_Inicial":153585.0,"KM_Final":153606.0,"Recorrido":21.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":"SE ACUDIO A UN LLAMADO DE AUXILIO DEBIDO A PROTESTAS DE MINEROS EL PARABRISAS DE LA CAMIONETA TERMINO SIENDO IMPACTADA POR PIEDRAS PARABRISAS ROTO, FOCO DELANTERO IZQUIERDO ROTO"},{"Fecha":"2025-07-11","Turno":"NOCHE","Conductor":"RULY PAREDES","Unidad_Movil":"EUG-707","KM_Inicial":153606.0,"KM_Final":153650.0,"Recorrido":44.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-12","Turno":"DIA","Conductor":"GONZALO RAMIREZ","Unidad_Movil":"EUG-707","KM_Inicial":153650.0,"KM_Final":153686.0,"Recorrido":36.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-12","Turno":"TARDE","Conductor":"FREBER MAMANI","Unidad_Movil":"EUG-707","KM_Inicial":153686.0,"KM_Final":153754.0,"Recorrido":68.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-12","Turno":"NOCHE","Conductor":"RULY PAREDES","Unidad_Movil":"EUG-707","KM_Inicial":153754.0,"KM_Final":153806.0,"Recorrido":52.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-13","Turno":"DIA","Conductor":"GONZALO RAMIREZ","Unidad_Movil":"EUG-707","KM_Inicial":153806.0,"KM_Final":243.4,"Recorrido":null,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":"MEDIANTE PATRULLAJE SE CALLO EL ESPEJO RETROVISOR DEBIDO AL PARABRISAS ROTO"},{"Fecha":"2025-07-13","Turno":"TARDE","Conductor":"FREBER MAMANI","Unidad_Movil":"EUG-717","KM_Inicial":151244.0,"KM_Final":151273.0,"Recorrido":29.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-13","Turno":"NOCHE","Conductor":"JUNIOR PI\u00d1A","Unidad_Movil":"EUG-717","KM_Inicial":151273.0,"KM_Final":151338.0,"Recorrido":65.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-14","Turno":"DIA","Conductor":"ALVARO SUBILETA","Unidad_Movil":"EUG-717","KM_Inicial":151338.0,"KM_Final":151437.0,"Recorrido":99.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-14","Turno":"TARDE","Conductor":"FREBER MAMANI","Unidad_Movil":"EUG-717","KM_Inicial":151437.0,"KM_Final":151442.0,"Recorrido":5.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-14","Turno":"NOCHE","Conductor":"JUNIOR PI\u00d1A","Unidad_Movil":"EUG-717","KM_Inicial":151442.0,"KM_Final":151480.0,"Recorrido":38.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-15","Turno":"DIA","Conductor":"RULY PAREDES","Unidad_Movil":"EUG-717","KM_Inicial":151480.0,"KM_Final":151556.0,"Recorrido":76.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-15","Turno":"DIA","Conductor":"DAVID CACERES","Unidad_Movil":"EX - 7680","KM_Inicial":48217.0,"KM_Final":48339.0,"Recorrido":120.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-15","Turno":"DIA","Conductor":"FREBER MAMANI","Unidad_Movil":"EX - 7664","KM_Inicial":39029.0,"KM_Final":39148.0,"Recorrido":119.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-15","Turno":"TARDE","Conductor":"JUNIOR PI\u00d1A","Unidad_Movil":"EUG-717","KM_Inicial":151556.0,"KM_Final":151655.0,"Recorrido":99.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-15","Turno":"NOCHE","Conductor":"ALVARO SUBILETA","Unidad_Movil":"EUG-717","KM_Inicial":151655.0,"KM_Final":151725.0,"Recorrido":70.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-16","Turno":"DIA","Conductor":"RULY PAREDES","Unidad_Movil":"EUG-717","KM_Inicial":151725.0,"KM_Final":151788.0,"Recorrido":63.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-16","Turno":"DIA","Conductor":"DAVID CACERES","Unidad_Movil":"EX - 7680","KM_Inicial":48339.0,"KM_Final":null,"Recorrido":null,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-16","Turno":"DIA","Conductor":"SAID GAMARRA","Unidad_Movil":"EX -7664","KM_Inicial":39148.0,"KM_Final":null,"Recorrido":null,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-16","Turno":"TARDE","Conductor":"JUNIOR PI\u00d1A","Unidad_Movil":"EUG-717","KM_Inicial":151788.0,"KM_Final":151845.0,"Recorrido":56.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-16","Turno":"NOCHE","Conductor":"ALVARO SUBILETA","Unidad_Movil":"EUG-717","KM_Inicial":151845.0,"KM_Final":151889.0,"Recorrido":44.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-17","Turno":"DIA","Conductor":"RULY PAREDES","Unidad_Movil":"EUG-717","KM_Inicial":151889.0,"KM_Final":151960.0,"Recorrido":71.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-17","Turno":"TARDE","Conductor":"JUNIOR PI\u00d1A","Unidad_Movil":"EUG-717","KM_Inicial":151960.0,"KM_Final":152043.0,"Recorrido":83.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-17","Turno":"NOCHE","Conductor":"ALVARO SUBILETA","Unidad_Movil":"EUG-717","KM_Inicial":152043.0,"KM_Final":152084.0,"Recorrido":41.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-18","Turno":"DIA","Conductor":"RULY PAREDES","Unidad_Movil":"EUG-717","KM_Inicial":152084.0,"KM_Final":152148.0,"Recorrido":64.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-18","Turno":"TARDE","Conductor":"JUNIOR PI\u00d1A","Unidad_Movil":"EUG-717","KM_Inicial":152148.0,"KM_Final":152233.0,"Recorrido":85.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-18","Turno":"NOCHE","Conductor":"ALVARO SUBILETA","Unidad_Movil":"EUG-717","KM_Inicial":152233.0,"KM_Final":152313.0,"Recorrido":80.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-19","Turno":"DIA","Conductor":"FREBER MAMANI","Unidad_Movil":"EUG-717","KM_Inicial":152313.0,"KM_Final":152373.0,"Recorrido":60.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-19","Turno":"TARDE","Conductor":"JUNIOR PI\u00d1A","Unidad_Movil":"EUG-717","KM_Inicial":152373.0,"KM_Final":152463.0,"Recorrido":90.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-19","Turno":"NOCHE","Conductor":"ALVARO SUBILETA","Unidad_Movil":"EUG-717","KM_Inicial":152463.0,"KM_Final":152523.0,"Recorrido":60.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-20","Turno":"DIA","Conductor":"RULY PAREDES","Unidad_Movil":"EUG-717","KM_Inicial":152523.0,"KM_Final":152600.0,"Recorrido":77.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-20","Turno":"TARDE","Conductor":"JUNIOR PI\u00d1A","Unidad_Movil":"EUG-717","KM_Inicial":152600.0,"KM_Final":152672.0,"Recorrido":72.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-20","Turno":"NOCHE","Conductor":"ALVARO SUBILETA","Unidad_Movil":"EUG-717","KM_Inicial":152672.0,"KM_Final":152736.0,"Recorrido":64.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-21","Turno":"DIA","Conductor":"RULY PAREDES","Unidad_Movil":"EUG-717","KM_Inicial":152736.0,"KM_Final":152800.0,"Recorrido":64.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-21","Turno":"TARDE","Conductor":"JUNIOR PI\u00d1A","Unidad_Movil":"EUG-717","KM_Inicial":152800.0,"KM_Final":152875.0,"Recorrido":75.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-21","Turno":"NOCHE","Conductor":"ALVARO SUBILETA","Unidad_Movil":"EUG-717","KM_Inicial":152875.0,"KM_Final":152914.0,"Recorrido":39.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-22","Turno":"DIA","Conductor":"RULY PAREDES","Unidad_Movil":"EUG-717","KM_Inicial":152914.0,"KM_Final":152994.0,"Recorrido":80.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-22","Turno":"TARDE","Conductor":"JUNIOR PI\u00d1A","Unidad_Movil":"EUG-717","KM_Inicial":152994.0,"KM_Final":153077.0,"Recorrido":83.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":"SE RELEVO LA CAMIONETA CON LA PANTALLA DE AUTORADIO ROTA"},{"Fecha":"2025-07-22","Turno":"NOCHE","Conductor":"ALVARO SUBILETA","Unidad_Movil":"EUG-717","KM_Inicial":153077.0,"KM_Final":153159.0,"Recorrido":82.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-23","Turno":"DIA","Conductor":"RULY PAREDES","Unidad_Movil":"EUG-717","KM_Inicial":153159.0,"KM_Final":153230.0,"Recorrido":71.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-23","Turno":"TARDE","Conductor":"JUNIOR PI\u00d1A","Unidad_Movil":"EUG-717","KM_Inicial":153230.0,"KM_Final":153307.0,"Recorrido":77.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-23","Turno":"NOCHE","Conductor":"GONZALO RAMIREZ","Unidad_Movil":"EUG-717","KM_Inicial":153307.0,"KM_Final":153390.0,"Recorrido":83.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-24","Turno":"DIA","Conductor":"RULY PAREDES","Unidad_Movil":"EUG-717","KM_Inicial":153390.0,"KM_Final":153455.0,"Recorrido":65.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-24","Turno":"TARDE","Conductor":"WILSON LUDE\u00d1A","Unidad_Movil":"EUG-717","KM_Inicial":153455.0,"KM_Final":153522.0,"Recorrido":67.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-24","Turno":"NOCHE","Conductor":"ALVARO SUBILETA","Unidad_Movil":"EUG-717","KM_Inicial":153522.0,"KM_Final":153563.0,"Recorrido":41.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-25","Turno":"DIA","Conductor":"RULY PAREDES","Unidad_Movil":"EUG-717","KM_Inicial":153563.0,"KM_Final":153606.0,"Recorrido":43.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-25","Turno":"TARDE","Conductor":"WILSON LUDE\u00d1A","Unidad_Movil":"EUG-717","KM_Inicial":153606.0,"KM_Final":153666.0,"Recorrido":60.0,"Combustible":180.0,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-25","Turno":"NOCHE","Conductor":"ALVARO SUBILETA","Unidad_Movil":"EUG-717","KM_Inicial":153666.0,"KM_Final":153740.0,"Recorrido":74.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-26","Turno":"DIA","Conductor":"FREBER MAMANI","Unidad_Movil":"EUG-717","KM_Inicial":153740.0,"KM_Final":153819.0,"Recorrido":79.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-26","Turno":"TARDE","Conductor":"WILSON LUDE\u00d1A","Unidad_Movil":"EUG-717","KM_Inicial":153819.0,"KM_Final":153882.0,"Recorrido":63.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-26","Turno":"NOCHE","Conductor":"ALVARO SUBILETA","Unidad_Movil":"EUG-717","KM_Inicial":153882.0,"KM_Final":153962.0,"Recorrido":80.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-27","Turno":"DIA","Conductor":"RULY PAREDES","Unidad_Movil":"EUG-717","KM_Inicial":153962.0,"KM_Final":154040.0,"Recorrido":78.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-27","Turno":"TARDE","Conductor":"WILSON LUDE\u00d1A","Unidad_Movil":"EUG-717","KM_Inicial":154040.0,"KM_Final":154114.0,"Recorrido":74.0,"Combustible":170.0,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-27","Turno":"NOCHE","Conductor":"ALVARO SUBILETA","Unidad_Movil":"EUG-717","KM_Inicial":154114.0,"KM_Final":154150.0,"Recorrido":36.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-28","Turno":"DIA","Conductor":"RULY PAREDES","Unidad_Movil":"EUG-717","KM_Inicial":154150.0,"KM_Final":154230.0,"Recorrido":80.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-28","Turno":"TARDE","Conductor":"JUNIOR PI\u00d1A","Unidad_Movil":"EUG-717","KM_Inicial":154230.0,"KM_Final":154318.0,"Recorrido":88.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-28","Turno":"NOCHE","Conductor":"ALVARO SUBILETA","Unidad_Movil":"EUG-717","KM_Inicial":154318.0,"KM_Final":154380.0,"Recorrido":62.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-29","Turno":"DIA","Conductor":"RULY PAREDES","Unidad_Movil":"EUG-717","KM_Inicial":154380.0,"KM_Final":154452.0,"Recorrido":72.0,"Combustible":200.0,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-29","Turno":"TARDE","Conductor":"WILSON LUDE\u00d1A","Unidad_Movil":"EUG-717","KM_Inicial":154452.0,"KM_Final":154548.0,"Recorrido":96.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-29","Turno":"NOCHE","Conductor":"GONZALO RAMIREZ","Unidad_Movil":"EUG-717","KM_Inicial":154548.0,"KM_Final":154598.0,"Recorrido":50.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-30","Turno":"DIA","Conductor":"RULY PAREDES","Unidad_Movil":"EUG-717","KM_Inicial":154598.0,"KM_Final":154682.0,"Recorrido":84.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-30","Turno":"TARDE","Conductor":"WILSON LUDE\u00d1A","Unidad_Movil":"EUG-717","KM_Inicial":154682.0,"KM_Final":154773.0,"Recorrido":91.0,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-30","Turno":"NOCHE","Conductor":"ALVARO SUBILETA","Unidad_Movil":"EUG-717","KM_Inicial":154773.0,"KM_Final":154817.0,"Recorrido":null,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-31","Turno":"DIA","Conductor":"RULY PAREDES","Unidad_Movil":"EUG-717","KM_Inicial":154817.0,"KM_Final":154869.0,"Recorrido":null,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-31","Turno":"TARDE","Conductor":"JUNIOR PI\u00d1A","Unidad_Movil":"EUG-717","KM_Inicial":154869.0,"KM_Final":null,"Recorrido":null,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null},{"Fecha":"2025-07-31","Turno":null,"Conductor":null,"Unidad_Movil":"EUG-717","KM_Inicial":null,"KM_Final":null,"Recorrido":null,"Combustible":null,"Cambio_Aceite":null,"Mantenimiento":null,"Ocurrencias":null}];

    // Overlay de errores
    (function () {
      const box = document.getElementById('errorBox');
      window.addEventListener('error', ev => { box.style.display='block'; box.textContent = 'Error JS: '+(ev.message||ev.error||''); });
      window.addEventListener('unhandledrejection', ev => { box.style.display='block'; box.textContent = 'Error Promesa: '+(ev.reason?.message || ev.reason || ''); });
    })();

    // Helpers
    const TURNOS = ["DIA","TARDE","NOCHE"];
    const toNumber = v => Number.isFinite(+v) ? +v : 0;
    const parseDateISO = s => { const d = new Date(s); return isNaN(d.getTime()) ? null : d; };
    const formatISO = d => d.toISOString().slice(0,10);

    function getMinMaxDate(rows){
      const dates = rows.map(r => parseDateISO(r.Fecha)).filter(Boolean);
      if(!dates.length) return {min:null, max:null};
      return { min:new Date(Math.min(...dates)), max:new Date(Math.max(...dates)) };
    }

    function calcularKPIs(rows){
      const combustiblePorTurno = TURNOS.map(t => rows.filter(r=>r.Turno===t).reduce((a,r)=>a+toNumber(r.Combustible),0));
      const kmPromedioPorTurno = TURNOS.map(t => {
        const recs = rows.filter(r=>r.Turno===t).map(r=>toNumber(r.Recorrido));
        const sum = recs.reduce((a,b)=>a+b,0);
        return Number((recs.length ? sum/recs.length : 0).toFixed(2));
      });
      const recorridoTotalPorTurno = TURNOS.map(t => rows.filter(r=>r.Turno===t).reduce((a,r)=>a+toNumber(r.Recorrido),0));
      const totalComb = combustiblePorTurno.reduce((a,b)=>a+b,0);
      const totalRec = recorridoTotalPorTurno.reduce((a,b)=>a+b,0);
      return { combustiblePorTurno, kmPromedioPorTurno, recorridoTotalPorTurno, totalComb, totalRec };
    }

    function filtrarDatos(rows, startDate, endDate, conductoresSeleccionados){
      const sd = startDate ? parseDateISO(startDate) : null;
      const ed = endDate   ? parseDateISO(endDate)   : null;
      const setCond = new Set(conductoresSeleccionados);
      return rows.filter(item => {
        const f = parseDateISO(item.Fecha);
        const byDate = (!sd || (f && f >= sd)) && (!ed || (f && f <= ed));
        const byCond = !setCond.size || setCond.has(String(item.Conductor||""));
        return byDate && byCond;
      });
    }

    // Charts
    let combustibleChart, kmPromedioChart, recorridoTotalChart;
    const commonOptions = {
      responsive: true,
      maintainAspectRatio: false,
      resizeDelay: 200,
      interaction: { mode: 'index', intersect: false },
      plugins: { legend: { position: 'top', labels: { boxWidth: 12, usePointStyle: true } } },
      scales: { x: { ticks: { maxRotation: 0, autoSkip: true } }, y: { beginAtZero: true, ticks: { autoSkip: true } } }
    };

    function initCharts(kpis){
      const c1 = document.getElementById('combustibleChart');
      const c2 = document.getElementById('kmPromedioChart');
      const c3 = document.getElementById('recorridoTotalChart');

      const ctx1 = c1?.getContext?.('2d');
      const ctx2 = c2?.getContext?.('2d');
      const ctx3 = c3?.getContext?.('2d');
      if(!ctx1 || !ctx2 || !ctx3){
        const box = document.getElementById('errorBox');
        box.style.display = 'block';
        box.textContent = 'No se pudo obtener el contexto de uno o más canvas.';
        return;
      }

      combustibleChart = new Chart(ctx1, {
        type:'bar',
        data:{ labels:["DÍA","TARDE","NOCHE"], datasets:[{ label:'Combustible por Turno (suma)', data:kpis.combustiblePorTurno }] },
        options: commonOptions
      });
      kmPromedioChart = new Chart(ctx2, {
        type:'bar',
        data:{ labels:["DÍA","TARDE","NOCHE"], datasets:[{ label:'Kilometraje Promedio por Turno', data:kpis.kmPromedioPorTurno }] },
        options: commonOptions
      });
      recorridoTotalChart = new Chart(ctx3, {
        type:'bar',
        data:{ labels:["DÍA","TARDE","NOCHE"], datasets:[{ label:'Recorrido Total por Turno', data:kpis.recorridoTotalPorTurno }] },
        options: commonOptions
      });
    }

    function updateCharts(kpis){
      if(!(combustibleChart && kmPromedioChart && recorridoTotalChart)) return;
      combustibleChart.data.datasets[0].data = kpis.combustiblePorTurno;
      kmPromedioChart.data.datasets[0].data = kpis.kmPromedioPorTurno;
      recorridoTotalChart.data.datasets[0].data = kpis.recorridoTotalPorTurno;
      combustibleChart.update(); kmPromedioChart.update(); recorridoTotalChart.update();
    }

    // Tabla & tarjetas
    function renderKpiCards(kpis, registros, totalRegistros){
      document.getElementById('kpiCombustibleTotal').textContent = kpis.totalComb.toFixed(2);
      document.getElementById('kpiRecorridoTotal').textContent = kpis.totalRec.toFixed(2);
      document.getElementById('kpiRegistros').textContent = registros;
      document.getElementById('resume').textContent = `Mostrando ${registros} de ${totalRegistros} registros.`;
    }

    function renderKpiTable(kpis){
      const wrap = document.getElementById('kpiTableWrap');
      wrap.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Turno</th>
              <th>Combustible (suma)</th>
              <th>Kilometraje Promedio</th>
              <th>Recorrido Total</th>
            </tr>
          </thead>
          <tbody>
            ${["DÍA","TARDE","NOCHE"].map((t,i)=>`
              <tr>
                <td>${t}</td>
                <td>${kpis.combustiblePorTurno[i].toFixed(2)}</td>
                <td>${kpis.kmPromedioPorTurno[i].toFixed(2)}</td>
                <td>${kpis.recorridoTotalPorTurno[i].toFixed(2)}</td>
              </tr>
            `).join("")}
          </tbody>
          <tfoot>
            <tr>
              <td>TOTALES</td>
              <td>${kpis.totalComb.toFixed(2)}</td>
              <td>—</td>
              <td>${kpis.totalRec.toFixed(2)}</td>
            </tr>
          </tfoot>
        </table>`;
    }

    // Checkboxes conductores
    function buildConductoresCheckboxes(rows){
      const listEl = document.getElementById('conductoresList');
      const buscarEl = document.getElementById('buscarConductor');
      const chkTodos = document.getElementById('chkTodos');
      const infoEl = document.getElementById('seleccionadosInfo');

      function allConductores(){
        const set = new Set(rows.map(r => String(r.Conductor||"").trim()).filter(Boolean));
        return Array.from(set).sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}));
      }

      function render(filterText=""){
        const conductores = allConductores().filter(n => n.toLowerCase().includes(filterText.toLowerCase()));
        listEl.innerHTML = "";
        conductores.forEach(nombre=>{
          const id = "cond_"+nombre.replace(/[^a-z0-9]+/gi,"_");
          const label = document.createElement('label');
          label.className = 'conductor-item';
          label.innerHTML = `<input type="checkbox" class="chk-conductor" id="${id}" data-nombre="${nombre}" checked /> ${nombre}`;
          listEl.appendChild(label);
        });
        updateInfo();
      }

      function seleccionados(){
        const sel=[]; listEl.querySelectorAll('.chk-conductor').forEach(chk=>{ if(chk.checked) sel.push(chk.getAttribute('data-nombre')); });
        return sel;
      }

      function setAll(checked){
        listEl.querySelectorAll('.chk-conductor').forEach(chk => chk.checked = checked);
        updateInfo();
      }

      function updateInfo(){
        const total = listEl.querySelectorAll('.chk-conductor').length;
        const sel = seleccionados().length;
        infoEl.textContent = `Seleccionados: ${sel} / ${total}`;
        chkTodos.checked = sel === total && total>0;
        chkTodos.indeterminate = sel>0 && sel<total;
      }

      buscarEl.addEventListener('input', ()=>render(buscarEl.value));
      listEl.addEventListener('change', e => { if(e.target.classList.contains('chk-conductor')) updateInfo(); });
      chkTodos.addEventListener('change', ()=>setAll(chkTodos.checked));

      render();
      return { getSeleccionados: seleccionados };
    }

    // Wiring
    document.addEventListener('DOMContentLoaded', ()=>{
      const startEl = document.getElementById('startDate');
      const endEl   = document.getElementById('endDate');
      const btn     = document.getElementById('btnFiltrar');

      const {min,max} = getMinMaxDate(DATA);
      if(min) startEl.value = formatISO(min);
      if(max) endEl.value   = formatISO(max);

      const conductoresUI = buildConductoresCheckboxes(DATA);

      const kpisInit = calcularKPIs(DATA);
      initCharts(kpisInit);
      renderKpiCards(kpisInit, DATA.length, DATA.length);
      renderKpiTable(kpisInit);

      function aplicarFiltros(){
        const seleccion = conductoresUI.getSeleccionados();
        const filtered  = filtrarDatos(DATA, startEl.value, endEl.value, seleccion);
        const kpis      = calcularKPIs(filtered);
        updateCharts(kpis);
        renderKpiCards(kpis, filtered.length, DATA.length);
        renderKpiTable(kpis);
      }

      btn.addEventListener('click', aplicarFiltros);
      startEl.addEventListener('change', aplicarFiltros);
      endEl.addEventListener('change', aplicarFiltros);
      document.getElementById('conductoresList').addEventListener('change', aplicarFiltros);
      document.getElementById('chkTodos').addEventListener('change', aplicarFiltros);
    });
  </script>
</body>
</html>
